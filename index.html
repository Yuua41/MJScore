<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mahjong Master Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
        background-color: #f8fafc;
      }
      input::-webkit-outer-spin-button,
      input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .view-section {
        display: none;
      }
      .view-section.active {
        display: block;
      }
      @keyframes highlight {
        0% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }
        50% {
          transform: scale(1.02);
          box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
        }
        100% {
          transform: scale(1);
        }
      }
      .jump-highlight {
        animation: highlight 1.5s ease-out;
        border-color: #10b981 !important;
        z-index: 10;
      }
      .player-input-container {
        position: relative;
        display: flex;
      }
      .line-numbers {
        text-align: right;
        padding: 1rem 0.5rem;
        background: #f1f5f9;
        color: #94a3b8;
        font-family: monospace;
        font-size: 0.875rem;
        line-height: 1.25rem;
        border-radius: 0.75rem 0 0 0.75rem;
        border: 1px solid #e2e8f0;
        border-right: none;
        user-select: none;
      }
      #playerInput {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
      }
    </style>
  </head>
  <body class="min-h-screen bg-slate-50 text-slate-900 pb-10">
    <header class="bg-emerald-800 text-white p-4 shadow-lg sticky top-0 z-50">
      <div class="max-w-6xl mx-auto flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center gap-2">
          ğŸ€„ éº»é›€å¤§ä¼šé–‹ã
        </h1>
        <div class="flex gap-2">
          <button
            onclick="handleSample()"
            class="text-[10px] bg-amber-500 hover:bg-amber-600 px-3 py-1 rounded font-bold transition-colors"
          >
            ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
          </button>
          <button
            onclick="handleReset()"
            class="text-[10px] bg-red-600 hover:bg-red-700 px-3 py-1 rounded font-bold transition-colors"
          >
            ãƒªã‚»ãƒƒãƒˆ
          </button>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 md:p-6">
      <nav
        class="flex gap-1 mb-8 bg-white p-1 rounded-xl shadow-sm border border-slate-200"
      >
        <button
          onclick="switchView('setup')"
          id="nav-setup"
          class="flex-1 py-2 text-sm font-bold rounded-lg transition-all bg-emerald-600 text-white"
        >
          è¨­å®š
        </button>
        <button
          onclick="switchView('schedule')"
          id="nav-schedule"
          class="flex-1 py-2 text-sm font-bold rounded-lg transition-all text-slate-400 opacity-30"
          disabled
        >
          å“çµ„
        </button>
        <button
          onclick="switchView('standings')"
          id="nav-standings"
          class="flex-1 py-2 text-sm font-bold rounded-lg transition-all text-slate-400 opacity-30"
          disabled
        >
          æˆç¸¾
        </button>
        <button
          onclick="switchView('individual')"
          id="nav-individual"
          class="flex-1 py-2 text-sm font-bold rounded-lg transition-all text-slate-400 opacity-30"
          disabled
        >
          å€‹äºº
        </button>
      </nav>

      <section id="view-setup" class="view-section active">
        <div
          class="max-w-2xl mx-auto bg-white p-6 md:p-10 rounded-2xl shadow-sm border border-slate-200 space-y-6"
        >
          <h2 class="text-xl font-bold text-slate-800">å¤§ä¼šãƒ»ãƒ«ãƒ¼ãƒ«è¨­å®š</h2>
          <div class="space-y-2">
            <label class="text-sm font-bold text-slate-500"
              >ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åï¼ˆæ”¹è¡Œã¾ãŸã¯åŠè§’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
            </label>
            <div class="player-input-container">
              <div id="lineNumbers" class="line-numbers">1</div>
              <textarea
                id="playerInput"
                rows="6"
                oninput="updatePlayerCount()"
                placeholder="ã‚¢ã‚«ã‚®&#13;&#10;Saki..."
                class="w-full p-4 border border-slate-200 rounded-r-xl bg-slate-50 focus:ring-2 focus:ring-emerald-500 outline-none text-sm text-slate-800"
              ></textarea>
            </div>
            <p class="text-right text-xs text-emerald-600 font-bold">
              ç¾åœ¨:
              <span id="pCount">0</span
              >å(4ã®å€æ•°ã«ãªã‚‹ã‚ˆã†ã«ä¸è¶³åˆ†ã¯é»’å­ãŒè¿½åŠ ã•ã‚Œã¾ã™)
            </p>
          </div>

          <div
            class="bg-slate-800 p-6 rounded-2xl space-y-4 shadow-inner text-white"
          >
            <div class="grid grid-cols-2 gap-4 text-xs font-bold">
              <div>
                æŒã¡ç‚¹<input
                  type="number"
                  id="cfg-start"
                  value="25000"
                  class="w-full p-2 bg-slate-700 border border-slate-600 rounded mt-1 outline-none"
                />
              </div>
              <div>
                è¿”ã—<input
                  type="number"
                  id="cfg-return"
                  value="30000"
                  class="w-full p-2 bg-slate-700 border border-slate-600 rounded mt-1 outline-none"
                />
              </div>
              <div>
                ã‚¦ãƒ (1-4)<input
                  type="number"
                  id="cfg-uma1"
                  value="30"
                  class="w-full p-2 bg-slate-700 border border-slate-600 rounded mt-1 outline-none"
                />
              </div>
              <div>
                ã‚¦ãƒ (2-3)<input
                  type="number"
                  id="cfg-uma2"
                  value="10"
                  class="w-full p-2 bg-slate-700 border border-slate-600 rounded mt-1 outline-none"
                />
              </div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="space-y-2">
              <label class="text-xs font-bold text-slate-500"
                >åŒç‚¹æ™‚ã®å‡¦ç†</label
              >
              <div class="flex bg-slate-100 p-1 rounded-lg">
                <button
                  onclick="setTieBreak('kamicha')"
                  id="btn-kamicha"
                  class="flex-1 py-2 text-[10px] font-bold rounded"
                >
                  ä¸Šå®¶å–ã‚Š
                </button>
                <button
                  onclick="setTieBreak('split')"
                  id="btn-split"
                  class="flex-1 py-2 text-[10px] font-bold rounded bg-white shadow"
                >
                  åŒç‚¹åˆ†ã‘
                </button>
              </div>
            </div>
            <div class="space-y-2">
              <label class="text-xs font-bold text-slate-500"> å¸­é †è¨­å®š </label>
              <select
                id="cfg-seatMode"
                class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-[10px] font-bold"
              >
                <option value="random">ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ</option>
                <option value="none">å¸­é †ã‚’è¡¨ç¤ºã—ãªã„</option>
              </select>
            </div>
          </div>
          <div class="space-y-2">
            <label class="text-xs font-bold text-slate-500">è©¦åˆæ•°</label>
            <select
              id="numRounds"
              class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-xs font-bold"
            >
              <option value="1">1å›æˆ¦</option>
              <option value="2">2å›æˆ¦</option>
              <option value="3">3å›æˆ¦</option>
              <option value="4" selected>4å›æˆ¦</option>
              <option value="5">5å›æˆ¦</option>
              <option value="6">6å›æˆ¦</option>
              <option value="7">7å›æˆ¦</option>
              <option value="8">8å›æˆ¦</option>
            </select>
          </div>
          <button
            onclick="startTournament()"
            class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold hover:bg-emerald-700 shadow-md transition-all active:scale-95"
          >
            å¤§ä¼šé–‹å§‹
          </button>
        </div>
      </section>

      <section id="view-schedule" class="view-section">
        <div
          id="round-tabs"
          class="flex gap-2 overflow-x-auto pb-2 no-scrollbar mb-6"
        ></div>
        <div
          id="tables-container"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"
        ></div>
      </section>

      <section id="view-standings" class="view-section">
        <div
          class="bg-white p-6 md:p-8 rounded-2xl border border-slate-200 shadow-sm overflow-x-auto"
        >
          <div class="flex justify-between items-center mb-8">
            <h2
              class="text-xl font-bold text-slate-800 flex items-center gap-2"
            >
              ğŸ“Š ç·åˆæˆç¸¾
            </h2>
            <span class="text-[10px] text-slate-400"
              >â€»é …ç›®åã‚¯ãƒªãƒƒã‚¯ã§ä¸¦ã³æ›¿ãˆ</span
            >
          </div>
          <div class="min-w-[800px]" id="standings-table-container"></div>
        </div>
      </section>

      <section id="view-individual" class="view-section">
        <div class="max-w-xl mx-auto space-y-6">
          <div
            class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm"
          >
            <h2 class="text-xl font-bold mb-6 text-slate-800">ğŸ‘¤ å€‹äººæ¤œç´¢</h2>
            <select
              id="individual-select"
              onchange="renderIndividualStats(this.value)"
              class="w-full p-4 rounded-xl border border-slate-200 bg-slate-50 outline-none focus:ring-2 focus:ring-emerald-500 font-bold mb-8 cursor-pointer"
            ></select>
            <div id="individual-content"></div>
          </div>
        </div>
      </section>
    </main>

    <script>
      const STORAGE_KEY = "mahjong_manager_v1";
      const SEAT_LABELS = ["æ±", "å—", "è¥¿", "åŒ—"];
      let tournament = null;
      let activeRound = 1;
      let tieBreakRule = "split";
      let sortConfig = { key: "totalPoints", direction: "desc" };

      function getPermutations(arr) {
        if (arr.length <= 1) return [arr];
        const perms = [];
        for (let i = 0; i < arr.length; i++) {
          const rest = getPermutations([
            ...arr.slice(0, i),
            ...arr.slice(i + 1),
          ]);
          for (const p of rest) perms.push([arr[i], ...p]);
        }
        return perms;
      }

      function findBestSeatAssignment(playerIds, history) {
        const permutations = getPermutations(playerIds);
        let minCost = Infinity;
        let best = playerIds;
        for (const p of permutations) {
          let cost = 0;
          for (let i = 0; i < 4; i++) {
            const count = history[p[i]] ? history[p[i]][i] : 0;
            cost += Math.pow(count, 2);
          }
          if (cost < minCost) {
            minCost = cost;
            best = p;
          }
        }
        return best;
      }

      function generateSchedule(players, numRounds) {
        const rounds = [];
        const seatCounts = {};
        players.forEach((p) => (seatCounts[p.id] = [0, 0, 0, 0]));
        for (let r = 1; r <= numRounds; r++) {
          const shuffled = [...players].sort(() => Math.random() - 0.5);
          const tables = [];
          const numTables = Math.floor(shuffled.length / 4);
          for (let t = 0; t < numTables; t++) {
            const groupIds = shuffled
              .slice(t * 4, (t + 1) * 4)
              .map((p) => p.id);
            const bestP = findBestSeatAssignment(groupIds, seatCounts);
            bestP.forEach((id, idx) => seatCounts[id][idx]++);
            tables.push({
              id: `r${r}-t${t + 1}`,
              playerIds: bestP,
              results: bestP.map((id) => ({
                playerId: id,
                score: 0,
                point: 0,
                rank: 0,
                isNegativeMode: false, // ãƒã‚¤ãƒŠã‚¹ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ä¿æŒç”¨
              })),
              isValidated: false,
              hasExtraSticks: false,
            });
          }
          rounds.push({ roundNumber: r, tables });
        }
        return rounds;
      }

      function calculateTableResult(table, config) {
        const umaValues = [
          config.uma1,
          config.uma2,
          -config.uma2,
          -config.uma1,
        ];
        const oka = ((config.returnPoints - config.startingPoints) * 4) / 1000;
        if (config.tieBreakRule === "kamicha") {
          const sorted = table.results
            .map((r, i) => ({ ...r, seat: i }))
            .sort((a, b) =>
              b.score !== a.score ? b.score - a.score : a.seat - b.seat,
            );
          return table.results.map((res) => {
            const idx = sorted.findIndex((s) => s.playerId === res.playerId);
            const rank = idx + 1;
            let p = (res.score - config.returnPoints) / 1000 + umaValues[idx];
            if (rank === 1) p += oka;
            return { ...res, rank, point: Math.round(p * 10) / 10 };
          });
        } else {
          const final = table.results.map((r) => ({ ...r, rank: 0, point: 0 }));
          const scoreGroups = {};
          table.results.forEach((r) => {
            if (!scoreGroups[r.score]) scoreGroups[r.score] = [];
            scoreGroups[r.score].push(r.playerId);
          });
          const sortedScores = Object.keys(scoreGroups)
            .map(Number)
            .sort((a, b) => b - a);
          let curRank = 1;
          sortedScores.forEach((score) => {
            const pIds = scoreGroups[score];
            const count = pIds.length;
            let totalUma = 0,
              totalRank = 0;
            for (let i = 0; i < count; i++) {
              totalUma += umaValues[curRank - 1 + i];
              totalRank += curRank + i;
            }
            const avgUma = totalUma / count;
            const avgRank = totalRank / count;
            const splitOka = curRank === 1 ? oka / count : 0;
            pIds.forEach((id) => {
              const idx = final.findIndex((f) => f.playerId === id);
              final[idx].rank = avgRank;
              final[idx].point =
                Math.round(
                  ((score - config.returnPoints) / 1000 + avgUma + splitOka) *
                    10,
                ) / 10;
            });
            curRank += count;
          });
          return final;
        }
      }

      function getDisplayName(pId) {
        if (!tournament) return "";
        const idx = tournament.players.findIndex((p) => p.id === pId);
        const p = tournament.players[idx];
        return p ? `${idx + 1}. ${p.name}` : "";
      }

      function getStandings() {
        if (!tournament) return [];
        const map = new Map();
        tournament.players.forEach((p) =>
          map.set(p.id, { pts: 0, sc: 0, ranks: [], count: 0 }),
        );
        tournament.rounds.forEach((r) =>
          r.tables.forEach((t) => {
            if (t.isValidated)
              t.results.forEach((res) => {
                const d = map.get(res.playerId);
                d.pts += res.point;
                d.sc += res.score;
                d.ranks.push(res.rank);
                d.count++;
              });
          }),
        );
        let list = tournament.players.map((p, idx) => {
          const d = map.get(p.id);
          return {
            playerId: p.id,
            playerName: p.name,
            displayIdx: idx + 1,
            totalPoints: d.pts,
            totalScore: d.sc,
            averageRank: d.ranks.length
              ? d.ranks.reduce((a, b) => a + b, 0) / d.ranks.length
              : 0,
            gamesPlayed: d.count,
          };
        });

        list.sort((a, b) => {
          let valA = a[sortConfig.key];
          let valB = b[sortConfig.key];
          if (typeof valA === "string") {
            return sortConfig.direction === "asc"
              ? valA.localeCompare(valB)
              : valB.localeCompare(valA);
          }
          return sortConfig.direction === "asc" ? valA - valB : valB - valA;
        });

        return list;
      }

      function switchView(viewName) {
        document
          .querySelectorAll(".view-section")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(`view-${viewName}`).classList.add("active");
        document.querySelectorAll("nav button").forEach((b) => {
          b.classList.remove("bg-emerald-600", "text-white", "shadow-sm");
          b.classList.add("text-slate-400");
        });
        const activeNav = document.getElementById(`nav-${viewName}`);
        activeNav.classList.add("bg-emerald-600", "text-white", "shadow-sm");
        activeNav.classList.remove("text-slate-400");
        if (viewName === "schedule") renderSchedule();
        if (viewName === "standings") renderStandings();
        if (viewName === "individual") renderIndividualSelect();
      }

      function updatePlayerCount() {
        const val = document.getElementById("playerInput").value;
        const names = val
          .split(/[\n,]+/)
          .map((n) => n.trim())
          .filter((n) => n);
        document.getElementById("pCount").innerText = names.length;

        const lineNumbers = document.getElementById("lineNumbers");
        const lines = val.split("\n").length;
        const maxLines = Math.max(lines, names.length, 1);
        let numHtml = "";
        for (let i = 1; i <= maxLines; i++) {
          numHtml += i + "<br>";
        }
        lineNumbers.innerHTML = numHtml;
      }

      function setTieBreak(rule) {
        tieBreakRule = rule;
        document.getElementById("btn-kamicha").className =
          rule === "kamicha"
            ? "flex-1 py-2 text-[10px] font-bold rounded bg-white shadow"
            : "flex-1 py-2 text-[10px] font-bold rounded";
        document.getElementById("btn-split").className =
          rule === "split"
            ? "flex-1 py-2 text-[10px] font-bold rounded bg-white shadow"
            : "flex-1 py-2 text-[10px] font-bold rounded";
      }

      function startTournament() {
        let names = document
          .getElementById("playerInput")
          .value.split(/[\n,]+/)
          .map((n) => n.trim())
          .filter((n) => n);
        if (!names.length) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        while (names.length % 4 !== 0)
          names.push(`é»’å­${4 - (names.length % 4)}`);
        const players = names.map((n) => ({
          id: crypto.randomUUID(),
          name: n,
        }));
        const config = {
          startingPoints: +document.getElementById("cfg-start").value,
          returnPoints: +document.getElementById("cfg-return").value,
          uma1: +document.getElementById("cfg-uma1").value,
          uma2: +document.getElementById("cfg-uma2").value,
          seatMode: document.getElementById("cfg-seatMode").value,
          tieBreakRule: tieBreakRule,
        };
        tournament = {
          players,
          rounds: generateSchedule(
            players,
            +document.getElementById("numRounds").value,
          ),
          config,
        };
        save();
        enableNav();
        switchView("schedule");
      }

      function enableNav() {
        ["schedule", "standings", "individual"].forEach((id) => {
          const btn = document.getElementById(`nav-${id}`);
          btn.disabled = false;
          btn.classList.remove("opacity-30");
        });
      }

      function formatP(v) {
        return `${v < 0 ? "â–²" : "+"}${Math.abs(v).toFixed(1)}`;
      }

      function renderSchedule() {
        const tabContainer = document.getElementById("round-tabs");
        tabContainer.innerHTML = tournament.rounds
          .map(
            (r) => `
                <button onclick="activeRound=${
                  r.roundNumber
                }; renderSchedule()" class="px-5 py-2 rounded-lg font-bold whitespace-nowrap transition-all ${
                  activeRound === r.roundNumber
                    ? "bg-slate-800 text-white shadow-md"
                    : "bg-white border text-slate-400"
                }">
                    ${r.roundNumber}å›æˆ¦
                </button>
            `,
          )
          .join("");

        const tableContainer = document.getElementById("tables-container");
        const round = tournament.rounds[activeRound - 1];
        tableContainer.innerHTML = round.tables
          .map((t, tIdx) => {
            const resultsHtml = t.playerIds
              .map((pId, pIdx) => {
                const displayName = getDisplayName(pId);
                const res = t.results.find((x) => x.playerId === pId);
                const isNeg = res.isNegativeMode || res.score < 0;
                const displayVal =
                  res.score === 0 ? "" : Math.abs(res.score / 100);

                return `
                        <div class="space-y-1">
                            <div class="flex justify-between text-[10px] font-bold">
                                <span class="text-slate-700 flex gap-2">
                                    ${
                                      tournament.config.seatMode === "random"
                                        ? `<span class="text-slate-300 font-mono w-4">${SEAT_LABELS[pIdx]}</span>`
                                        : ""
                                    }
                                    ${displayName}
                                </span>
                                ${
                                  t.isValidated
                                    ? `<span class="${
                                        res.point >= 0
                                          ? "text-emerald-600"
                                          : "text-red-500"
                                      }">${res.rank}ä½ / ${formatP(
                                        res.point,
                                      )}</span>`
                                    : ""
                                }
                            </div>
                            <div class="flex gap-1.5">
                                <button ${
                                  t.isValidated ? "disabled" : ""
                                } onclick="toggleNegative(${
                                  activeRound - 1
                                }, ${tIdx}, '${pId}')" class="px-2.5 rounded border transition-all text-[10px] font-bold ${
                                  isNeg
                                    ? "bg-red-50 border-red-200 text-red-600"
                                    : "bg-slate-50 border-slate-200 text-slate-300"
                                }">â–²</button>
                                <input type="number" 
                                  ${t.isValidated ? "disabled" : ""} 
                                  value="${displayVal}" 
                                  onfocus="this.select()"
                                  oninput="updateScore(${
                                    activeRound - 1
                                  }, ${tIdx}, '${pId}', this.value)" 
                                  class="flex-grow p-2 rounded border border-slate-200 text-right font-bold text-sm outline-none focus:ring-1 focus:ring-emerald-400" 
                                  placeholder="0">
                                <span class="text-[10px] text-slate-300 self-center font-bold font-mono">00</span>
                            </div>
                        </div>`;
              })
              .join("");

            return `
                    <div id="table-card-${activeRound}-${
                      tIdx + 1
                    }" class="bg-white rounded-2xl border-2 transition-all shadow-sm ${
                      t.isValidated ? "border-emerald-500" : "border-slate-100"
                    }">
                        <div class="p-3 text-white font-bold flex justify-between items-center rounded-t-xl ${
                          t.isValidated ? "bg-emerald-500" : "bg-slate-700"
                        }">
                            <span>å“ ${tIdx + 1}</span>
                            <label class="flex items-center gap-1.5 text-[10px] cursor-pointer bg-black/10 px-2 py-0.5 rounded">
                                <input type="checkbox" onchange="toggleExtraSticks(${
                                  activeRound - 1
                                }, ${tIdx}, this.checked)" ${
                                  t.hasExtraSticks ? "checked" : ""
                                } ${t.isValidated ? "disabled" : ""} class="w-3 h-3">
                                <span>å“å¤–ç‚¹æ£’ã‚ã‚Š</span>
                            </label>
                        </div>
                        <div class="p-5 space-y-4">
                            ${resultsHtml}
                            <div class="flex gap-2">
                                <button onclick="resetTable(${
                                  activeRound - 1
                                }, ${tIdx})" 
                                    ${t.isValidated ? "disabled" : ""}
                                    class="px-3 py-3 rounded-xl font-bold text-xs bg-slate-100 text-slate-500 hover:bg-slate-200 disabled:opacity-50">
                                    ãƒªã‚»ãƒƒãƒˆ
                                </button>
                                <button onclick="confirmTable(${
                                  activeRound - 1
                                }, ${tIdx})" class="flex-grow py-3 rounded-xl font-bold text-xs transition-all ${
                                  t.isValidated
                                    ? "bg-slate-100 text-slate-500 hover:bg-slate-200"
                                    : "bg-emerald-600 text-white shadow-sm hover:bg-emerald-700"
                                }">
                                    ${t.isValidated ? "ã‚¹ã‚³ã‚¢ä¿®æ­£" : "ã‚¹ã‚³ã‚¢ç¢ºå®š"}
                                </button>
                            </div>
                        </div>
                    </div>`;
          })
          .join("");
      }

      function handleSort(key) {
        if (sortConfig.key === key) {
          sortConfig.direction =
            sortConfig.direction === "asc" ? "desc" : "asc";
        } else {
          sortConfig.key = key;
          sortConfig.direction = key === "totalPoints" ? "desc" : "asc";
        }
        renderStandings();
      }

      function renderStandings() {
        const standings = getStandings();
        const container = document.getElementById("standings-table-container");

        const getSortIcon = (key) => {
          if (sortConfig.key !== key) return "â†•ï¸";
          return sortConfig.direction === "asc" ? "ğŸ”¼" : "ğŸ”½";
        };

        let roundsHeader = tournament.rounds
          .map((r) => `<th class="pb-4 px-2 text-right">R${r.roundNumber}</th>`)
          .join("");

        let rows = standings
          .map((s, i) => {
            let roundCells = tournament.rounds
              .map((r) => {
                const table = r.tables.find((t) =>
                  t.playerIds.includes(s.playerId),
                );
                const res = table
                  ? table.results.find((x) => x.playerId === s.playerId)
                  : null;
                const isValid = table && table.isValidated;
                return `<td class="py-4 px-2 text-right font-mono text-xs ${
                  !isValid
                    ? "text-slate-200"
                    : res.point >= 0
                      ? "text-slate-600"
                      : "text-rose-400"
                }">
                        ${isValid ? formatP(res.point) : "-"}
                    </td>`;
              })
              .join("");
            return `<tr class="border-b border-slate-50">
                    <td class="py-4 px-2 text-center font-bold text-xs">${
                      i + 1
                    }</td>
                    <td class="py-4 px-2"><button onclick="viewIndividual('${
                      s.playerId
                    }')" class="font-bold text-emerald-700 hover:underline">${
                      s.displayIdx
                    }. ${s.playerName}</button></td>
                    ${roundCells}
                    <td class="py-4 px-2 text-right font-black text-base ${
                      s.totalPoints >= 0 ? "text-emerald-600" : "text-rose-500"
                    }">${formatP(s.totalPoints)}</td>
                </tr>`;
          })
          .join("");

        container.innerHTML = `
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr class="text-slate-400 text-[10px] uppercase font-bold cursor-pointer">
                            <th>Rank</th>
                            <th onclick="handleSort('displayIdx')">Player ${getSortIcon(
                              "displayIdx",
                            )}</th>
                            ${roundsHeader}
                            <th onclick="handleSort('totalPoints')" class="text-right">Total ${getSortIcon(
                              "totalPoints",
                            )}</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>`;
      }

      function viewIndividual(pId) {
        document.getElementById("individual-select").value = pId;
        renderIndividualStats(pId);
        switchView("individual");
      }

      function renderIndividualSelect() {
        const select = document.getElementById("individual-select");
        const current = select.value;
        select.innerHTML =
          '<option value="">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ</option>' +
          tournament.players
            .map(
              (p, idx) =>
                `<option value="${p.id}">${idx + 1}. ${p.name}</option>`,
            )
            .join("");
        select.value = current;
      }

      function renderIndividualStats(pId) {
        const content = document.getElementById("individual-content");
        if (!pId) {
          content.innerHTML =
            '<div class="py-20 text-center text-slate-300">é¸æŠã—ã¦ãã ã•ã„</div>';
          return;
        }
        const stats = getStandings().find((s) => s.playerId === pId);
        const historyHtml = tournament.rounds
          .map((r) => {
            const t = r.tables.find((x) => x.playerIds.includes(pId));
            const res = t ? t.results.find((x) => x.playerId === pId) : null;
            const seatIdx = t ? t.playerIds.indexOf(pId) : -1;
            const tIdx = t
              ? tournament.rounds[r.roundNumber - 1].tables.indexOf(t) + 1
              : 0;
            return `
                    <div onclick="goToTable(${
                      r.roundNumber
                    }, ${tIdx})" class="cursor-pointer flex justify-between items-center p-4 bg-slate-50 rounded-xl border border-slate-100 hover:bg-white hover:border-emerald-400 hover:shadow-md transition-all group">
                        <div class="flex items-center gap-4">
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-slate-700">${
                                      r.roundNumber
                                    }å›æˆ¦</span>
                                    ${
                                      tournament.config.seatMode === "random" &&
                                      seatIdx !== -1
                                        ? `<span class="text-[10px] bg-white border border-slate-200 px-1.5 py-0.5 rounded text-slate-400 font-bold">${SEAT_LABELS[seatIdx]}å®¶</span>`
                                        : ""
                                    }
                                </div>
                                ${
                                  t && t.isValidated
                                    ? `<div class="text-[10px] font-bold text-emerald-600">${
                                        res.rank
                                      }ä½ / ${formatP(res.point)}pt</div>`
                                    : '<div class="text-[10px] text-slate-300 italic">æœªç¢ºå®š</div>'
                                }
                            </div>
                        </div>
                        ${
                          t
                            ? `<span class="text-[10px] bg-slate-800 text-white px-3 py-1 rounded-full font-bold group-hover:bg-emerald-600 transition-colors">å“ ${tIdx}</span>`
                            : ""
                        }
                    </div>`;
          })
          .join("");
        content.innerHTML = `<div class="grid grid-cols-2 gap-4 mb-6"><div class="bg-emerald-50 p-4 rounded-xl text-center"><p class="text-[10px] text-emerald-600 font-bold uppercase">Total</p><p class="text-xl font-black">${formatP(
          stats.totalPoints,
        )}</p></div><div class="bg-slate-50 p-4 rounded-xl text-center"><p class="text-[10px] text-slate-400 font-bold uppercase">Avg Rank</p><p class="text-xl font-black">${stats.averageRank.toFixed(
          2,
        )}</p></div></div><div class="space-y-3"> ${historyHtml} </div>`;
      }

      function goToTable(roundNum, tableNum) {
        if (!tableNum) return;
        activeRound = roundNum;
        switchView("schedule");
        setTimeout(() => {
          const targetId = `table-card-${roundNum}-${tableNum}`;
          const targetTable = document.getElementById(targetId);
          if (targetTable) {
            targetTable.scrollIntoView({ behavior: "smooth", block: "center" });
            targetTable.classList.add("jump-highlight");
            setTimeout(
              () => targetTable.classList.remove("jump-highlight"),
              2000,
            );
          }
        }, 150);
      }

      function updateScore(rIdx, tIdx, pId, val) {
        if (!tournament) return;
        const table = tournament.rounds[rIdx].tables[tIdx];
        const res = table.results.find((r) => r.playerId === pId);

        let numVal = val === "" ? 0 : parseInt(val, 10);
        if (isNaN(numVal)) numVal = 0;

        // ç¾åœ¨ãƒã‚¤ãƒŠã‚¹ãƒ¢ãƒ¼ãƒ‰ã€ã‚‚ã—ãã¯æ—¢ã«ãƒã‚¤ãƒŠã‚¹å€¤ãªã‚‰ãƒã‚¤ãƒŠã‚¹ã¨ã—ã¦è¨ˆç®—
        const isNegative = res.isNegativeMode || res.score < 0;
        res.score = numVal * 100 * (isNegative ? -1 : 1);

        // æ•°å€¤ãŒå…¥ã£ãŸå¾Œã¯ã€è¨ˆç®—å¾Œã®ç¬¦å·ãŒæ­£ã—ã‘ã‚Œã°ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚ªãƒ•ã«ã™ã‚‹ï¼ˆè¦‹ãŸç›®èª¿æ•´ã®ãŸã‚ï¼‰
        if (numVal > 0) res.isNegativeMode = isNegative;

        save();
      }

      function toggleNegative(rIdx, tIdx, pId) {
        const table = tournament.rounds[rIdx].tables[tIdx];
        const res = table.results.find((r) => r.playerId === pId);

        // ç¬¦å·ã‚’åè»¢ã•ã›ã‚‹
        res.isNegativeMode = !res.isNegativeMode;

        // æ—¢ã«æ•°å€¤ãŒå…¥ã£ã¦ã„ã‚‹å ´åˆã¯å³åº§ã«ç¬¦å·ã‚’åæ˜ 
        if (res.score !== 0) {
          res.score *= -1;
          // æ•°å€¤ãŒã‚ã‚‹å ´åˆã¯è¨ˆç®—å¾Œã®ç¬¦å·ã«åˆã‚ã›ã‚‹
          res.isNegativeMode = res.score < 0;
        }

        save();
        renderSchedule();
      }

      function toggleExtraSticks(rIdx, tIdx, checked) {
        tournament.rounds[rIdx].tables[tIdx].hasExtraSticks = checked;
        save();
      }

      function resetTable(rIdx, tIdx) {
        if (!confirm("å…¥åŠ›å†…å®¹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆ0ç‚¹ï¼‰ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const table = tournament.rounds[rIdx].tables[tIdx];
        table.results.forEach((r) => {
          r.score = 0;
          r.isNegativeMode = false;
        });
        save();
        renderSchedule();
      }

      function confirmTable(rIdx, tIdx) {
        const table = tournament.rounds[rIdx].tables[tIdx];
        if (table.isValidated) {
          if (!confirm("ç¢ºå®šã‚’è§£é™¤ã—ã¦ä¿®æ­£ã—ã¾ã™ã‹ï¼Ÿ")) return;
          table.isValidated = false;
          save();
          renderSchedule();
          return;
        }

        const currentTotal = table.results.reduce((sum, r) => sum + r.score, 0);
        const expectedTotal = tournament.config.startingPoints * 4;

        if (!table.hasExtraSticks && currentTotal !== expectedTotal) {
          const diff = currentTotal - expectedTotal;
          const msg = `ç‚¹æ•°ãŒåˆã„ã¾ã›ã‚“ã€‚\n\nç¾åœ¨ã®åˆè¨ˆ: ${currentTotal}\nè¦å®šã®åˆè¨ˆ: ${expectedTotal}\nå·®åˆ†: ${diff}\n\nã“ã®ã¾ã¾ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ`;
          if (!confirm(msg)) return;
        }

        table.results = calculateTableResult(table, tournament.config);
        table.isValidated = true;
        save();
        renderSchedule();
      }

      function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tournament));
      }
      function handleReset() {
        if (confirm("ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
          localStorage.removeItem(STORAGE_KEY);
          location.reload();
        }
      }
      function handleSample() {
        if (
          !confirm(
            "ã‚µãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ç¾åœ¨å…¥åŠ›ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ãŒã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
          )
        )
          return;

        document.getElementById("playerInput").value = [
          "ã‚¢ã‚«ã‚®",
          "ã‚«ã‚¤ã‚¸",
          "è¡£",
          "ç…§",
          "ä¸€å§«",
          "å’²",
          "å„ªå¸Œ",
          "å“²ä¹Ÿ",
        ].join("\n");
        updatePlayerCount();
        startTournament();
        tournament.rounds.forEach((r) =>
          r.tables.forEach((t) => {
            t.results.forEach(
              (res, i) => (res.score = [41000, 29000, 24900, 5100][i]),
            );
            t.results = calculateTableResult(t, tournament.config);
            t.isValidated = true;
          }),
        );
        save();
        renderStandings();
        switchView("standings");
      }

      window.onload = () => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          tournament = JSON.parse(saved);
          enableNav();
          switchView("standings");
        }
        updatePlayerCount();
      };
    </script>
  </body>
</html>
